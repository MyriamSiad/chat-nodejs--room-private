<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css"> 
    <title>Chat Bot temps r√©el </title>
    </head>

<body>
    <div id="username-prompt">
            <div id="username-box">
                <h2>Choisissez votre nom d'utilisateur</h2>
                <form id="username-form">
                    <input type="text" id="username-input" placeholder="Entrez votre nom" required>
                    <button type="submit">Rejoindre le Chat</button>
                </form>
            </div>
        </div>


    
<div id="chat-container-public">
    <div id="messages-container-public">
        <div class="message received">Bonjour !</div>
        <div class="message sent">Salut !</div>
        
    </div>
<div id="typing-indicator"></div>
    <div id="input-area-public">
        <form id="message-form-public">
            <input type="text" id="user-input-public" placeholder="Tapez votre message ici...">
            
            <button id="send-button-public" type="submit">Envoyer</button>
        </form>
    </div>
</div>

<div id="chat-container-priv√©" class ="hidden">
    <div id="messages-container-priv√©">
        <div class="message sent">Bonjour !</div>
        <div class="message received">Salut !</div>
    </div>

    <div id="input-area-priv√©">
        <form id="message-form-priv√©">
            <input type="text" id="user-input-priv√©" placeholder="Tapez votre message ici...">
            <input type="hidden" id="recipient-id-field" value="">
            <button id="send-button-priv√©" type="submit">Envoyer</button>
        </form>
    </div>
</div>

<hr>



    <div id="user-list-box">
            <h2>üë• Utilisateurs Connect√©s</h2>
            <div id="users-list-container"> 
            </div>
        </div>

</body>

<script src="/socket.io/socket.io.js"></script> 
<script>

    const buttonSubmit = document.getElementById("send-button-public");
    const messageContainer = document.getElementById('messages-container-public');
    const formPublic = document.getElementById("message-form-public");
    const formPrivee = document.getElementById("message-form-priv√©")
    const userInputPrive = document.getElementById("user-input-priv√©");
    const userInput = document.getElementById("user-input-public");
    const modalForm = document.getElementById("username-form");
    const userNameInput = document.getElementById("username-input");
    const UsernamePrompt = document.getElementById("username-prompt");
    const containerPrivee = document.getElementById("chat-container-priv√©");
    const usersListContainer = document.getElementById("users-list-container");
    const typingIndactor = document.getElementById("typing-indicator");
    let userName = "";
    const socket = io();
    
function createNewSocketConnectionAsync() {
    return new Promise((resolve) => {
        const newSocket = io('http://localhost:3000'); 
        
        newSocket.on('connect', () => {
            // L'ID est disponible ici, on r√©sout la Promise avec cet ID
            resolve(newSocket.id);
        })
    });
}


async function getSomeUsersId(){
    const id_Users = [];
    try{
        for(i = 0 ; i<=5 ; i++){
        const id_socket = await  createNewSocketConnectionAsync();
        id_Users.push(id_socket);
        }
        return id_Users;
    }catch (error){
        console.log(error.message)
    }
}



usersListContainer.addEventListener('click', (e) => {
    const clickedElement = e.target;

    if (clickedElement.classList.contains('user-item') || clickedElement.tagName === 'P') {
        
        // R√©cup√©rer le nom d'utilisateur cliqu√©
        const selectedUserName = clickedElement.textContent.trim();
        document.getElementById('chat-container-priv√©').classList.remove('hidden');
        console.log(`Utilisateur s√©lectionn√© : ${selectedUserName}`);

    }
});
modalForm.addEventListener("submit" , (e) => {
        e.preventDefault();     
        if(userNameInput.value !== ""){
            const username = userNameInput.value;
            socket.emit('set_username', (username));
            UsernamePrompt.style.display = "none";
            userName = userNameInput.value;
        }
    })


    function getId(){
        return socket.id;
    }
    function getUsername(){
        return userName;
    }

    function userConnected(msg){
        const messagesContainer = document.getElementById('messages-container-public');
        const p = document.createElement('p');
        p.textContent = msg;
        messagesContainer.appendChild(p);
        
    }

    function userDisconnected(msg){
        const messagesContainer = document.getElementById('messages-container-public');
        const p = document.createElement('p');
        p.textContent = msg;
        messagesContainer.appendChild(p);
    }

    


socket.on('connect', () => {
        const id = socket.id;
        console.log(`‚úÖ Connect√© au serveur. Socket ID: ${id}`);
        // Vous pouvez ajouter ici la logique pour mettre √† jour l'interface utilisateur
    });







    socket.on('disconnect', (reason) => {
        console.log(`‚ùå D√©connect√© du serveur.`);
        console.log(`Raison de la d√©connexion: ${reason}`);
        // Affichera une raison comme "transport close" ou "ping timeout"
    });

    socket.on('chat_message', msg  => {

        console.log(msg);
    })

    socket.on("connexion" , msg =>{
        userConnected(msg);
    });

    socket.on("deconnexion" , msg => {
        console.log(msg);
        userDisconnected(msg);
    })


socket.on('users_list_update', async (users) => {
const listContainer = document.getElementById('users-list-container');
const id_input = document.getElementById('recipient-id-field');
const flag = false; 

 listContainer.innerHTML ='';
    users.forEach(user => {
        
        if (user.name !== getUsername()) {
            // N'affiche pas son propre nom
            const item = document.createElement('p');
            item.textContent = user.name;
            id_input.value = user.id;
            item.classList.add('user-item');
            listContainer.appendChild(item);
        }
    });
});






function appendMessageReceivedPublic(userMessageObject) {
    const container = document.getElementById('messages-container-public');
    
    const messageElement = document.createElement('div');
    const userNameElement = document.createElement('p');

    // Affichage dans le chat PUBLIC, marqu√© comme RE√áU
    messageElement.className = 'message received';
    userNameElement.className = 'username-label received';
    
    messageElement.textContent = userMessageObject.message;
    userNameElement.textContent = `‚Äî ${userMessageObject.user}`;
    
    messageElement.appendChild(userNameElement);
    container.appendChild(messageElement);

    container.scrollTop = container.scrollHeight;
}


function appendMessageSentPrivee(userMessageObject) {
    const container = document.getElementById('messages-container-priv√©');
    
    const messageElement = document.createElement('div');
    const userNameElement = document.createElement('p');

    // Affichage dans le chat PRIV√â, marqu√© comme ENVOY√â
    messageElement.className = 'message sent';
    userNameElement.className = 'username-label sent';
    
    messageElement.textContent = userMessageObject.message;
    // Afficher le destinataire
    
    messageElement.appendChild(userNameElement);
    container.appendChild(messageElement);

    container.scrollTop = container.scrollHeight;
}




formPublic.addEventListener("submit" , (e) =>{

    e.preventDefault();
    if(userInput.value !== ""){

    //userMessage = userInput.value;
    const userMessageObject = {
        user : `${getUsername()}`,
        message : userInput.value    
    };
    
    socket.emit('chat_message', userMessageObject);

    userInput.value = "";
    }
    })

socket.on('chat_message', msg => {
    appendMessageReceivedPublic(msg); 
});

formPrivee.addEventListener("submit" , (e) =>{

    e.preventDefault();
    const formElement = e.target;
    if(userInputPrive.value !== ""){
    const recipientIdField = formElement.querySelector("#recipient-id-field");
    
   // console.log(e.target.getAttribute('data-socket-id'));
    const recipientSocketId = recipientIdField.value
        console.log(recipientSocketId);
        //userMessage = userInput.value;
    const userMessageObject = {
        id : `${recipientSocketId}`,
        user : `${getUsername()}`,
        message : userInputPrive.value    
    };
    socket.emit('private_message', userMessageObject);
    appendMessageSentPrivee(userMessageObject);
    userInputPrive.value = "";
    }
    })

socket.on('private_message_received' , userMessageObject => {
    document.getElementById('chat-container-priv√©').classList.remove('hidden');
    appendMessageReceivedPrivee(userMessageObject);
    //appendMessageSentPrivee(userMessageObject);
});



function appendMessageReceivedPrivee(userMessageObject) {
    const container = document.getElementById('messages-container-priv√©');
    
    // Cr√©er les √©l√©ments
    const messageElement = document.createElement('div');
    const userNameElement = document.createElement('p');

    // Assigner les classes (received = que VOUS avez re√ßu)
    messageElement.className = 'message received';
    userNameElement.className = 'username-label received'; 

    // Contenu : Le message re√ßu et le nom de l'exp√©diteur
    messageElement.textContent = userMessageObject.message;
    
    // Assemblage et ajout
    messageElement.appendChild(userNameElement);
    container.appendChild(messageElement);

    // D√©filement
    container.scrollTop = container.scrollHeight;
}

userInput.addEventListener('input', e => {
    const userName = getUsername();
    socket.emit("est_entrain_ecrire" , userName) 
});


//Permet de vider la div qui contient le TypingIndicator 
//lorsqu'il recoit le flux "typing_stop"
//Cepedant faut trouver comment pouvoir emmettre en premier lieu le : 
//socket.on('a_arreter_ecrire', () => {....}
//cot√© client !!

socket.on('typing_stop' , () => {
    typingIndactor.innerHTML = "";
})

socket.on('typing_start',  userName => {

    //Condition qui permet d'empecher le d√©doublement de la balise p √† chaque input du user
    if(!typingIndactor.querySelector('p')){
        const p = document.createElement('p')
        p.textContent = `${userName} est entrain d'√©crire ....`;
        typingIndactor.appendChild(p);
    }
});











</script>

</html>
